<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Corruption-Proof Auto Repair + Mycelial Strategy Nexus</title>

  <!-- SEO -->
  <meta name="description" content="Universal corruption-proof auto repair checklist with advanced Mycelial Strategy Nexus, offline-first architecture, export capabilities, analytics, and multi-theme support for Master and Grandmaster strategic planning." />
  <meta name="keywords" content="auto repair, anti-corruption, mechanic checklist, habitica, indexeddb, strategy bank, master plan, grandmaster plan, offline-first, automotive safety" />
  <link rel="canonical" href="https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid" />

  <!-- Open Graph -->
  <meta property="og:title" content="Corruption-Proof Auto Repair + Strategy Nexus" />
  <meta property="og:description" content="Comprehensive checklist with mycelial strategy banking for Master and Grandmaster planning." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><rect fill='%23000' width='1200' height='630'/><text x='50%' y='50%' fill='%23fff' font-size='48' font-family='sans-serif' text-anchor='middle' dominant-baseline='middle'>Auto Repair Strategy Nexus</text></svg>" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />

  <!-- PWA -->
  <meta name="theme-color" content="#071018" />
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:%22Auto Repair Strategy Nexus%22,%22short_name&quot;:%22Auto+Nexus%22,%22start_url&quot;:%22.%2Findex.html%22,%22display&quot;:%22standalone%22,%22background_color&quot;:%22#000000%22,%22theme_color%22;:%22#071018%22,%22icons%22:[{&quot;src&quot;:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%23071018' width='512' height='512'/%3E%3Ctext x='50%25' y='50%25' fill='%23fff' font-size='240' font-family='sans-serif' text-anchor='middle' dominant-baseline='middle'%3Eüîß%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": [
      "https://schema.org",
      "https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid"
    ],
    "@type": "HowTo",
    "name": "Corruption-Proof Auto Repair Checklist",
    "description": "Globally portable checklist with mycelial strategy nexus for Master/Grandmaster planning. Offline-first, privacy-respecting, zero-harm.",
    "totalTime": "PT30M",
    "tool": ["Smartphone camera", "Notepad", "Witness (optional)"],
    "supply": ["Vehicle documentation", "Previous repair records"],
    "step": [
      {"@type":"HowToStep","name":"Document vehicle details","text":"Record make, model, year, mileage, VIN. Maintain digital and physical copies."},
      {"@type":"HowToStep","name":"List symptoms objectively","text":"Describe observations, not diagnoses. Note sounds, smells, lights, behavior."},
      {"@type":"HowToStep","name":"Research baseline pricing","text":"Compare labor rates and parts costs across multiple sources."},
      {"@type":"HowToStep","name":"Bring documentation witness","text":"Second person or timestamped visit log prevents misconduct."},
      {"@type":"HowToStep","name":"Photographic documentation","text":"Photos of odometer, condition, issues with EXIF timestamps."},
      {"@type":"HowToStep","name":"Demand written estimates","text":"Itemized diagnostic fees, parts, labor hours, taxes, fees."},
      {"@type":"HowToStep","name":"Request old parts return","text":"Transparency signal; legitimate shops comply readily."},
      {"@type":"HowToStep","name":"Verify shop credentials","text":"License, insurance, certifications, accreditations."},
      {"@type":"HowToStep","name":"Mark critical parts","text":"Discreet washable marks on high-swap-risk components."},
      {"@type":"HowToStep","name":"Assess work environment","text":"Clean, organized bays correlate with professional practices."},
      {"@type":"HowToStep","name":"Written authorization for changes","text":"Photos, technical reason, updated estimate for any additions."},
      {"@type":"HowToStep","name":"Maintain time records","text":"Log drop-off and pickup times; detect hour inflation."},
      {"@type":"HowToStep","name":"Sign only complete invoices","text":"Never sign blank or open-ended documents."},
      {"@type":"HowToStep","name":"Verify parts provenance","text":"Prefer OEM or quality aftermarket; document serial numbers."},
      {"@type":"HowToStep","name":"Post-repair test drive","text":"Within 24 hours verify symptom resolution."},
      {"@type":"HowToStep","name":"Mileage verification","text":"Small variance normal; significant changes warrant inquiry."},
      {"@type":"HowToStep","name":"Inspect returned parts","text":"Compare actual condition to claimed necessity."},
      {"@type":"HowToStep","name":"Comprehensive record retention","text":"Estimates, invoices, warranties, communications."},
      {"@type":"HowToStep","name":"Publish factual review","text":"Rate honesty, clarity, timeliness, quality."}
    ]
  }
  </script>

  <style>
    /* ============================================
       SECTION: CSS VARIABLES & THEME SYSTEM
       PURPOSE: Centralized color/spacing tokens for easy theming
       USAGE: Change theme via theme selector dropdown
       EXPECTED: Instant theme switching without page reload
       ============================================ */
    :root {
      /* Default Space Theme */
      --bg: #03060b;
      --fg: #e9f1ff;
      --muted: #9bb1c9;
      --accent: #66e3ff;
      --accent-glow: rgba(102, 227, 255, 0.15);
      --ok: #77ff9f;
      --warn: #ffd166;
      --bad: #ff6b6b;
      --card: rgba(10, 18, 28, 0.72);
      --card-border: rgba(255, 255, 255, 0.08);
      --glass: rgba(255, 255, 255, 0.04);
      --shadow: rgba(0, 0, 0, 0.35);
      --nebula-1: rgba(32, 92, 255, 0.15);
      --nebula-2: rgba(255, 96, 204, 0.10);
      --nebula-3: rgba(0, 255, 214, 0.08);
    }

    /* Medieval Theme */
    [data-theme="medieval"] {
      --bg: #1a0f08;
      --fg: #f4e8d8;
      --muted: #b89968;
      --accent: #d4af37;
      --accent-glow: rgba(212, 175, 55, 0.15);
      --ok: #8fbc8f;
      --warn: #cd853f;
      --bad: #8b0000;
      --card: rgba(42, 28, 18, 0.72);
      --card-border: rgba(212, 175, 55, 0.12);
      --glass: rgba(212, 175, 55, 0.04);
      --nebula-1: rgba(139, 69, 19, 0.15);
      --nebula-2: rgba(160, 82, 45, 0.10);
      --nebula-3: rgba(210, 180, 140, 0.08);
    }

    /* Cyberpunk Theme */
    [data-theme="cyberpunk"] {
      --bg: #0a0014;
      --fg: #ff00ff;
      --muted: #b300ff;
      --accent: #00ffff;
      --accent-glow: rgba(0, 255, 255, 0.25);
      --ok: #39ff14;
      --warn: #ffea00;
      --bad: #ff0080;
      --card: rgba(25, 0, 40, 0.72);
      --card-border: rgba(255, 0, 255, 0.15);
      --glass: rgba(255, 0, 255, 0.06);
      --nebula-1: rgba(255, 0, 255, 0.20);
      --nebula-2: rgba(0, 255, 255, 0.15);
      --nebula-3: rgba(57, 255, 20, 0.10);
    }

    /* Nature/Forest Theme */
    [data-theme="nature"] {
      --bg: #0d1f0d;
      --fg: #e8f5e9;
      --muted: #81c784;
      --accent: #66bb6a;
      --accent-glow: rgba(102, 187, 106, 0.15);
      --ok: #aed581;
      --warn: #ffb74d;
      --bad: #e57373;
      --card: rgba(27, 48, 27, 0.72);
      --card-border: rgba(102, 187, 106, 0.12);
      --glass: rgba(102, 187, 106, 0.04);
      --nebula-1: rgba(56, 142, 60, 0.15);
      --nebula-2: rgba(46, 125, 50, 0.10);
      --nebula-3: rgba(104, 159, 56, 0.08);
    }

    /* Anime/Pastel Theme */
    [data-theme="anime"] {
      --bg: #fef6fb;
      --fg: #2d1b2e;
      --muted: #8b7e8f;
      --accent: #ff6ec7;
      --accent-glow: rgba(255, 110, 199, 0.15);
      --ok: #7bed9f;
      --warn: #feca57;
      --bad: #ff6b81;
      --card: rgba(255, 240, 250, 0.82);
      --card-border: rgba(255, 110, 199, 0.15);
      --glass: rgba(255, 110, 199, 0.06);
      --shadow: rgba(45, 27, 46, 0.15);
      --nebula-1: rgba(255, 110, 199, 0.12);
      --nebula-2: rgba(123, 237, 159, 0.08);
      --nebula-3: rgba(254, 202, 87, 0.08);
    }

    /* Ocean Theme */
    [data-theme="ocean"] {
      --bg: #001a33;
      --fg: #e6f3ff;
      --muted: #6fa3d1;
      --accent: #00d4ff;
      --accent-glow: rgba(0, 212, 255, 0.15);
      --ok: #4dd9c8;
      --warn: #ffb84d;
      --bad: #ff5757;
      --card: rgba(0, 40, 77, 0.72);
      --card-border: rgba(0, 212, 255, 0.12);
      --glass: rgba(0, 212, 255, 0.04);
      --nebula-1: rgba(0, 119, 182, 0.15);
      --nebula-2: rgba(0, 176, 255, 0.10);
      --nebula-3: rgba(77, 217, 200, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      scroll-behavior: smooth;
    }

    body {
      background: radial-gradient(1200px 800px at 70% 10%, var(--card) 0%, var(--bg) 60%, #000 100%);
      color: var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* ============================================
       SECTION: ANIMATED BACKGROUND SYSTEM
       PURPOSE: Visual depth and engagement via parallax starfield
       USAGE: Automatically renders on page load
       EXPECTED: 60fps animated background with mouse parallax
       ============================================ */
    #starfield {
      position: fixed;
      inset: 0;
      z-index: -2;
      background: #000;
    }

    .nebula {
      position: fixed;
      inset: -10%;
      z-index: -1;
      pointer-events: none;
      background:
        radial-gradient(60% 40% at 15% 20%, var(--nebula-1), transparent 60%),
        radial-gradient(50% 35% at 80% 30%, var(--nebula-2), transparent 65%),
        radial-gradient(40% 30% at 60% 70%, var(--nebula-3), transparent 70%);
      filter: blur(20px) saturate(110%);
      transition: background 0.5s ease;
    }

    /* ============================================
       SECTION: HEADER & NAVIGATION
       PURPOSE: Sticky navigation with stats and theme selector
       USAGE: Always visible during scroll
       EXPECTED: Semi-transparent backdrop blur, accessibility support
       ============================================ */
    header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 20px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, rgba(3, 6, 11, 0.95), rgba(3, 6, 11, 0.7), transparent);
      border-bottom: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      z-index: 1000;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: clamp(16px, 3vw, 26px);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .header-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
      align-items: center;
    }

    .header-controls {
      margin-left: auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ============================================
       SECTION: BUTTON SYSTEM
       PURPOSE: Consistent interactive elements with hover states
       USAGE: Apply .btn class with optional modifiers (.acc, .ok, .warn, .bad)
       EXPECTED: Accessible, touch-friendly, animated feedback
       ============================================ */
    .btn {
      appearance: none;
      border: 1px solid var(--card-border);
      background: var(--glass);
      color: var(--fg);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
      border-color: var(--accent);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.acc {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .btn.ok {
      border-color: var(--ok);
      background: rgba(119, 255, 159, 0.08);
    }

    .btn.warn {
      border-color: var(--warn);
      background: rgba(255, 209, 102, 0.08);
    }

    .btn.bad {
      border-color: var(--bad);
      background: rgba(255, 107, 107, 0.08);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ============================================
       SECTION: MAIN LAYOUT & CARDS
       PURPOSE: Content containers with glassmorphism effect
       USAGE: Wrap sections in .card class
       EXPECTED: Responsive layout with consistent spacing
       ============================================ */
    main {
      max-width: 1200px;
      margin: 24px auto 120px;
      padding: 0 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin: 20px 0;
      box-shadow: 0 10px 40px var(--shadow);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 15px 50px var(--shadow), 0 0 40px var(--accent-glow);
    }

    /* ============================================
       SECTION: TYPOGRAPHY & TEXT UTILITIES
       PURPOSE: Consistent text styling and hierarchy
       USAGE: Apply utility classes for consistent spacing
       EXPECTED: Readable, accessible text with semantic hierarchy
       ============================================ */
    h2 {
      font-size: clamp(20px, 4vw, 28px);
      margin: 0 0 16px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--accent);
    }

    h3 {
      font-size: clamp(18px, 3vw, 22px);
      margin: 0 0 12px;
      font-weight: 600;
    }

    h4 {
      font-size: 16px;
      margin: 8px 0;
      font-weight: 600;
    }

    p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .small {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    .muted {
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: var(--glass);
      color: var(--muted);
      font-weight: 500;
    }

    /* ============================================
       SECTION: GRID LAYOUTS
       PURPOSE: Responsive column layouts
       USAGE: Apply .grid2, .grid3, .cols3 classes
       EXPECTED: Auto-collapse to single column on mobile
       ============================================ */
    .intro {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 20px;
    }

    @media (max-width: 1000px) {
      .intro {
        grid-template-columns: 1fr;
      }
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    .grid3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .grid3 {
        grid-template-columns: 1fr;
      }
    }

    .cols3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .cols3 {
        grid-template-columns: 1fr;
      }
    }

    .bank-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
    }

    @media (max-width: 1000px) {
      .bank-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============================================
       SECTION: FORM INPUTS
       PURPOSE: Consistent form styling with accessibility
       USAGE: Style all input, textarea, select elements
       EXPECTED: Clear focus states, proper contrast, touch-friendly
       ============================================ */
    input,
    textarea,
    select {
      width: 100%;
      background: var(--glass);
      color: var(--fg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
    }

    label.small {
      font-size: 13px;
      color: var(--muted);
      margin: 8px 0 4px;
    }

    /* ============================================
       SECTION: CHECKLIST STEPS
       PURPOSE: Interactive checkbox list with progress tracking
       USAGE: Each step auto-saves state to IndexedDB
       EXPECTED: Accessible checkboxes with clear labels
       ============================================ */
    .step {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      padding: 16px;
      border-bottom: 1px dashed var(--card-border);
      transition: background 0.2s ease;
    }

    .step:last-child {
      border-bottom: none;
    }

    .step:hover {
      background: var(--glass);
    }

    .step input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .step .label {
      flex: 1;
    }

    .step .label strong {
      color: var(--fg);
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    /* ============================================
       SECTION: STRATEGY BANK COMPONENTS
       PURPOSE: Visual hierarchy for strategies and plans
       USAGE: Display strategies with tags, stage, impact
       EXPECTED: Scannable cards with action buttons
       ============================================ */
    .strategy {
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px;
      margin: 12px 0;
      background: var(--glass);
      transition: all 0.2s ease;
    }

    .strategy:hover {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.06);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      font-size: 12px;
      border: 1px solid var(--card-border);
      border-radius: 999px;
      background: var(--glass);
      font-weight: 500;
    }

    .tag {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 11px;
      margin-right: 6px;
      margin-bottom: 4px;
      background: var(--glass);
      transition: all 0.2s ease;
    }

    .tag:hover {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .kbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 8px 0;
      align-items: center;
    }

    .cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
    }

    /* ============================================
       SECTION: SCROLLABLE LISTS
       PURPOSE: Contained scrolling for long strategy lists
       USAGE: Apply .list class to containers
       EXPECTED: Smooth scrolling with custom scrollbar
       ============================================ */
    .list {
      max-height: 600px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .list::-webkit-scrollbar {
      width: 8px;
    }

    .list::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 10px;
    }

    .list::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 10px;
    }

    .list::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* ============================================
       SECTION: SEARCH & FILTER INTERFACE
       PURPOSE: Client-side search for strategies
       USAGE: Filter by text, tags, stage
       EXPECTED: Instant filtering without backend calls
       ============================================ */
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }

    .search-box input {
      padding-right: 40px;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }

    /* ============================================
       SECTION: STATS DASHBOARD
       PURPOSE: Visual analytics for checklist and strategies
       USAGE: Auto-updates as user interacts
       EXPECTED: Real-time progress indicators
       ============================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }

    .stat-card {
      background: var(--glass);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      margin: 8px 0;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ============================================
       SECTION: PROGRESS BAR
       PURPOSE: Visual progress indicator for checklist
       USAGE: Auto-updates based on checked items
       EXPECTED: Smooth animation on progress changes
       ============================================ */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--glass);
      border-radius: 999px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--ok));
      border-radius: 999px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%;
    }

    /* ============================================
       SECTION: TOOLTIPS & MODAL SYSTEM
       PURPOSE: Contextual help and dialogs
       USAGE: Hover for tooltips, click for modals
       EXPECTED: Accessible, keyboard-navigable
       ============================================ */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 8px;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--muted);
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--bad);
    }

    /* ============================================
       SECTION: FOOTER
       PURPOSE: Attribution, licensing, safety notices
       USAGE: Always at page bottom
       EXPECTED: Accessible links, clear legal info
       ============================================ */
    footer {
      max-width: 1200px;
      margin: 40px auto 80px;
      padding: 0 16px;
      border-top: 1px dashed var(--card-border);
      padding-top: 32px;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
      transition: color 0.2s;
    }

    footer a:hover {
      color: var(--ok);
      text-decoration: underline;
    }

    code,
    kbd {
      background: var(--glass);
      padding: 2px 8px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    /* ============================================
       SECTION: ACCESSIBILITY UTILITIES
       PURPOSE: Screen reader support, keyboard navigation
       USAGE: Apply .sr for screen-reader-only content
       EXPECTED: WCAG AA compliance
       ============================================ */
    .sr {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
    }

    /* ============================================
       SECTION: PRINT STYLESHEET
       PURPOSE: Clean PDF export formatting
       USAGE: Automatically applies when printing
       EXPECTED: Optimized for paper/PDF output
       ============================================ */
    @media print {
      body {
        background: white;
        color: black;
      }

      .no-print,
      header .header-controls,
      .btn,
      #starfield,
      .nebula {
        display: none !important;
      }

      .card {
        border: 1px solid #ccc;
        page-break-inside: avoid;
        box-shadow: none;
      }

      a[href]:after {
        content: " (" attr(href) ")";
      }
    }

    /* ============================================
       SECTION: ANIMATIONS & TRANSITIONS
       PURPOSE: Smooth micro-interactions
       USAGE: Automatically applied to interactive elements
       EXPECTED: 60fps smooth animations
       ============================================ */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    /* ============================================
       SECTION: RESPONSIVE DESIGN
       PURPOSE: Mobile-first responsive breakpoints
       USAGE: Automatically adapts to screen size
       EXPECTED: Usable on all devices from 320px to 4K
       ============================================ */
    @media (max-width: 600px) {
      header {
        padding: 12px 16px;
      }

      main {
        padding: 0 12px;
      }

      .card {
        padding: 16px;
        border-radius: 16px;
      }

      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }

      h2 {
        font-size: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============================================
       SECTION: NO SCRIPT FALLBACK
       PURPOSE: Graceful degradation without JavaScript
       USAGE: Shows warning if JS disabled
       EXPECTED: Basic functionality preserved
       ============================================ */
    noscript {
      display: block;
      padding: 20px;
      background: var(--warn);
      color: #000;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body data-theme="space">
  <!-- No Script Warning -->
  <noscript>
    ‚ö†Ô∏è This application requires JavaScript for full functionality. Please enable JavaScript in your browser.
  </noscript>

  <!-- Background Layers -->
  <canvas id="starfield" aria-hidden="true"></canvas>
  <div class="nebula" aria-hidden="true"></div>

  <!-- Main Header -->
  <header>
    <h1>üîß Corruption-Proof Auto Repair + Strategy Nexus</h1>
    <div class="header-stats">
      <span class="badge">
        <span id="headerProgress">0%</span> Complete
      </span>
      <span class="badge">
        <span id="headerStrategies">0</span> Strategies
      </span>
    </div>
    <div class="header-controls">
      <select id="themeSelector" class="btn" aria-label="Theme selector" title="Change visual theme">
        <option value="space">üåå Space</option>
        <option value="medieval">‚öîÔ∏è Medieval</option>
        <option value="cyberpunk">ü§ñ Cyberpunk</option>
        <option value="nature">üåø Nature</option>
        <option value="anime">üéå Anime</option>
        <option value="ocean">üåä Ocean</option>
      </select>
      <button class="btn no-print" id="btnPrint" title="Print or save as PDF">üñ®Ô∏è Print</button>
      <button class="btn no-print" id="btnStats" title="View detailed statistics">üìä Stats</button>
    </div>
  </header>

  <main>
    <!-- ============================================
         SECTION: INTRODUCTION & QUICK ACTIONS
         PURPOSE: Overview and primary export buttons
         USAGE: First thing users see, sets context
         EXPECTED: Clear value prop, immediate actions
         ============================================ -->
    <section class="intro card fade-in" role="region" aria-labelledby="intro-h">
      <h2 id="intro-h" class="sr">Introduction</h2>
      <div>
        <h3 style="margin-top: 0;">üéØ Mission</h3>
        <p>
          <strong>Keep car repairs honest</strong> with a universally translatable checklist. 
          Then <em>grow successful tactics</em> into a living <strong>Mycelial Strategy Nexus</strong>‚Äîcross-pollinate 
          patterns into <strong>Master Plans</strong> and <strong>Grandmaster Plans</strong>. 
          All offline-first, privacy-respecting, zero-harm.
        </p>
        
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-fill" id="mainProgressBar"></div>
        </div>
        
        <div class="cta-row">
          <button class="btn acc" id="btnExportHabitica" title="Push checklist to Habitica task manager">
            üìã Export to Habitica
          </button>
          <button class="btn ok" id="btnExportText" title="Download as plain text file">
            üìÑ Export Text
          </button>
          <button class="btn" id="btnExportPDF" title="Export as PDF document">
            üìë Export PDF
          </button>
          <button class="btn warn" id="btnReset" title="Clear all checklist progress">
            üîÑ Reset Checklist
          </button>
        </div>
        <div role="status" aria-live="polite">
          <span class="small" id="statusMsg"></span>
        </div>
      </div>

      <!-- Quick Red Flags -->
      <div class="card" style="background: var(--glass); border-color: var(--bad);">
        <h3 style="margin-top: 0; color: var(--bad);">üö© Quick Red Flags</h3>
        <div class="kbar" aria-label="Warning signs">
          <span class="pill">No written estimate</span>
          <span class="pill">Pressure tactics</span>
          <span class="pill">"Shop supplies" &gt; 5%</span>
          <span class="pill">Replace everything</span>
          <span class="pill">Won't return old parts</span>
          <span class="pill">Vague explanations</span>
        </div>
        <p class="small" style="margin-top: 12px;">
          üí° <strong>Pro Tip:</strong> Record odometer reading and take timestamped photos 
          before dropping off your vehicle. This creates an immutable baseline.
        </p>
      </div>
    </section>

    <!-- ============================================
         SECTION: STATISTICS DASHBOARD
         PURPOSE: Real-time analytics and insights
         USAGE: View progress, strategy counts, activity
         EXPECTED: Updates live as user interacts
         ============================================ -->
    <section class="card fade-in" role="region" aria-labelledby="stats-h">
      <h2 id="stats-h">üìä Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Checklist Progress</div>
          <div class="stat-number" id="statProgress">0%</div>
          <div class="small"><span id="statChecked">0</span> / <span id="statTotal">0</span> items</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Strategy Bank</div>
          <div class="stat-number" id="statStrategies">0</div>
          <div class="small">Total strategies</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Master Plan</div>
          <div class="stat-number" id="statMaster">0</div>
          <div class="small">Items in plan</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Grandmaster Plan</div>
          <div class="stat-number" id="statGrand">0</div>
          <div class="small">Items in plan</div>
        </div>
      </div>
    </section>

    <!-- ============================================
         SECTION: HABITICA & WEBLLM INTEGRATION
         PURPOSE: Optional third-party integrations
         USAGE: Store credentials locally, never transmitted
         EXPECTED: Secure local-only storage
         ============================================ -->
    <section class="grid2">
      <div class="card fade-in" role="region" aria-labelledby="habitica-h">
        <h3 id="habitica-h">üìã Habitica Integration (Optional)</h3>
        <p class="small">
          Connect your Habitica account to export checklists as tasks. 
          Credentials stored <strong>locally only</strong> in IndexedDB‚Äînever transmitted to third parties.
        </p>
        <form id="habiticaForm" autocomplete="off">
          <label class="small">
            User ID
            <input 
              id="habiticaUser" 
              type="text" 
              inputmode="text" 
              placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
              aria-describedby="habitica-help"
            />
          </label>
          
          <label class="small" style="margin-top: 12px;">
            API Token
            <input 
              id="habiticaToken" 
              type="password" 
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              aria-describedby="habitica-help"
            />
          </label>
          
          <p id="habitica-help" class="small" style="margin-top: 8px;">
            Find these in your Habitica Settings ‚Üí API. Your credentials never leave your device.
          </p>
          
          <div class="cta-row">
            <button class="btn ok" type="submit">üíæ Save Credentials</button>
            <span class="small" id="habiticaSaveMsg"></span>
          </div>
        </form>
      </div>

      <div class="card fade-in" role="region" aria-labelledby="webllm-h">
        <h3 id="webllm-h">ü§ñ On-Device AI Assistant (Optional)</h3>
        <p class="small">
          If WebLLM is available, ask for coaching on repair steps or strategies. 
          Runs <strong>100% on your device</strong>‚Äîno cloud API calls.
        </p>
        
        <label class="small">
          Your Question
          <textarea 
            id="llmPrompt" 
            rows="3" 
            placeholder="e.g., 'How do I verify a fair diagnostic fee?' or 'What should I look for in a written estimate?'"
          ></textarea>
        </label>
        
        <div class="cta-row">
          <button class="btn acc" id="btnLLM">üß† Ask AI</button>
        </div>
        
        <div 
          id="llmOut" 
          class="small" 
          role="log" 
          aria-live="polite"
          style="white-space: pre-wrap; padding: 14px; border: 1px solid var(--card-border); border-radius: 10px; background: var(--glass); min-height: 60px; margin-top: 12px;"
        ></div>
        
        <p class="small" id="llmStatus" style="margin-top: 8px;"></p>
      </div>
    </section>

    <!-- ============================================
         SECTION: MAIN CHECKLIST
         PURPOSE: Core corruption-proof checklist
         USAGE: Check items as completed, auto-saves
         EXPECTED: Persistent state, accessible
         ============================================ -->
    <section class="card fade-in" role="region" aria-labelledby="list-h">
      <h2 id="list-h">‚úÖ Corruption-Proof Checklist</h2>
      <p class="muted" style="margin-bottom: 16px;">
        Follow these steps sequentially for maximum protection. Each item is a proven tactic 
        against common repair shop scams.
      </p>
      
      <div id="steps"></div>
      
      <div class="cta-row" style="margin-top: 20px; border-top: 1px dashed var(--card-border); padding-top: 16px;">
        <span class="badge">
          Progress: <strong id="progressPct">0%</strong>
        </span>
        <span class="badge">
          Completed: <strong id="progressCount">0</strong> / <strong id="progressTotal">0</strong>
        </span>
        <button class="btn" id="btnExpandAll">üìÇ Expand All</button>
        <button class="btn" id="btnCollapseAll">üìÅ Collapse All</button>
      </div>
    </section>

    <!-- ============================================
         SECTION: MYCELIAL STRATEGY NEXUS
         PURPOSE: Growing knowledge base from atomic tactics
         USAGE: Create, tag, stage, and cross-pollinate strategies
         EXPECTED: Living document that evolves with use
         ============================================ -->
    <section class="card fade-in" role="region" aria-labelledby="bank-h">
      <h2 id="bank-h">üå± Mycelial Strategy Nexus</h2>
      <p class="muted">
        Store atomic "moves" (Actions). Tag them, evolve through growth stages 
        (<strong>Seed ‚Üí Mycelium ‚Üí Fruiting</strong>), and cross-pollinate into Master/Grandmaster plans. 
        Drag-drop <code>.json</code> files anywhere to import strategies or plans.
      </p>

      <div class="bank-grid">
        <!-- Left Column: Create/Filter/List Strategies -->
        <div>
          <!-- Strategy Creation Form -->
          <div class="strategy">
            <h4 style="margin-top: 0;">‚ûï Add / Update Strategy</h4>
            <p class="small muted">
              Create atomic, reusable tactics. Title should be action-oriented. 
              Stage reflects maturity: Seed (idea), Mycelium (tested), Fruiting (proven).
            </p>
            
            <div class="grid3">
              <label class="small">
                Title *
                <input 
                  id="stTitle" 
                  type="text"
                  placeholder="e.g., Request old parts back"
                  required
                  aria-required="true"
                />
              </label>
              
              <label class="small">
                Stage
                <select id="stStage" aria-label="Strategy maturity stage">
                  <option value="seed">üå± Seed (Untested)</option>
                  <option value="mycelium">üçÑ Mycelium (Testing)</option>
                  <option value="fruiting">üéØ Fruiting (Proven)</option>
                </select>
              </label>
              
              <label class="small">
                Impact (1-5)
                <input 
                  id="stImpact" 
                  type="number" 
                  min="1" 
                  max="5" 
                  value="3"
                  aria-label="Strategy impact rating"
                />
              </label>
            </div>
            
            <label class="small" style="margin-top: 12px;">
              Tags (comma-separated)
              <input 
                id="stTags" 
                type="text"
                placeholder="transparency, estimate, photos, documentation"
                aria-describedby="tags-help"
              />
            </label>
            <p id="tags-help" class="small muted" style="margin-top: 4px;">
              Use tags to categorize and filter strategies. Max 10 tags.
            </p>
            
            <label class="small" style="margin-top: 12px;">
              Description
              <textarea 
                id="stDesc" 
                rows="4" 
                placeholder="What is this action? How do you do it? What's the expected outcome? Be specific and actionable."
              ></textarea>
            </label>
            
            <div class="cta-row">
              <button class="btn ok" id="btnAddStrategy">üíæ Save Strategy</button>
              <button class="btn warn" id="btnClearStrategy">üîÑ Clear Form</button>
              <span class="small" id="stMsg" role="status"></span>
            </div>
          </div>

          <!-- Filter Interface -->
          <div class="strategy">
            <h4 style="margin-top: 0;">üîç Filter Strategies</h4>
            
            <div class="grid3">
              <label class="small">
                Search Text
                <input 
                  id="fltText" 
                  type="search"
                  placeholder="Search title or description"
                  aria-label="Search strategies by text"
                />
              </label>
              
              <label class="small">
                Tag Filter
                <input 
                  id="fltTag" 
                  type="text"
                  placeholder="e.g., estimate"
                  aria-label="Filter by tag"
                />
              </label>
              
              <label class="small">
                Stage Filter
                <select id="fltStage" aria-label="Filter by stage">
                  <option value="">All Stages</option>
                  <option value="seed">üå± Seed</option>
                  <option value="mycelium">üçÑ Mycelium</option>
                  <option value="fruiting">üéØ Fruiting</option>
                </select>
              </label>
            </div>
            
            <div class="cta-row">
              <button class="btn" id="btnApplyFilter">üîé Apply Filters</button>
              <button class="btn" id="btnResetFilter">‚Ü∫ Reset Filters</button>
              <button class="btn acc" id="btnExportStrategies">üì¶ Export Strategies</button>
            </div>
          </div>

          <!-- Strategy List -->
          <div class="strategy">
            <h4 style="margin-top: 0;">üìö Your Strategies</h4>
            <div 
              id="strategyList" 
              class="list" 
              role="feed" 
              aria-live="polite"
              aria-label="Strategy list"
            ></div>
          </div>
        </div>

        <!-- Right Column: Master/Grandmaster Plans -->
        <div>
          <div class="strategy">
            <h4 style="margin-top: 0;">üéØ Plans</h4>
            <p class="small muted">
              Cross-pollinate strategies into cohesive plans. Master Plans are tactical; 
              Grandmaster Plans are strategic/visionary.
            </p>
            
            <!-- Master Plan -->
            <div style="margin-top: 16px;">
              <div class="kbar">
                <span class="pill">‚ö° Master Plan</span>
                <button class="btn ok" id="btnExportMaster" title="Export Master Plan as JSON">
                  üíæ Export
                </button>
                <button class="btn bad" id="btnClearMaster" title="Clear all items from Master Plan">
                  üóëÔ∏è Clear
                </button>
              </div>
              <div 
                id="masterList" 
                class="list" 
                role="feed" 
                aria-live="polite"
                aria-label="Master plan items"
                style="max-height: 400px;"
              ></div>
            </div>
            
            <hr style="border: none; border-top: 1px dashed var(--card-border); margin: 20px 0;">
            
            <!-- Grandmaster Plan -->
            <div>
              <div class="kbar">
                <span class="pill">üëë Grandmaster Plan</span>
                <button class="btn ok" id="btnExportGrand" title="Export Grandmaster Plan as JSON">
                  üíæ Export
                </button>
                <button class="btn bad" id="btnClearGrand" title="Clear all items from Grandmaster Plan">
                  üóëÔ∏è Clear
                </button>
              </div>
              <div 
                id="grandList" 
                class="list" 
                role="feed" 
                aria-live="polite"
                aria-label="Grandmaster plan items"
                style="max-height: 400px;"
              ></div>
            </div>
          </div>

          <!-- Import & Backup Controls -->
          <div class="strategy">
            <h4 style="margin-top: 0;">üíæ Data Management</h4>
            <p class="small muted">
              <strong>Drag & drop</strong> any <code>.json</code> file onto the page to import. 
              We merge intelligently using persistent IDs‚Äîno duplicates.
            </p>
            
            <div class="cta-row">
              <button class="btn acc" id="btnExportAll" title="Full backup of all data">
                üì¶ Full Backup
              </button>
              <button class="btn warn" id="btnWipeAll" title="Delete all strategy bank data">
                ‚ö†Ô∏è Wipe All Data
              </button>
            </div>
            
            <div role="status" aria-live="polite" style="margin-top: 8px;">
              <span class="small" id="importMsg"></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================================
         SECTION: SAFETY & ATTRIBUTION
         PURPOSE: Zero-harm commitment, licenses, attribution
         USAGE: Always visible, non-negotiable
         EXPECTED: Clear ethical stance, legal compliance
         ============================================ -->
    <section class="card" role="note" aria-label="Safety and Ethics Notice" style="border-color: var(--ok);">
      <h3 style="margin-top: 0; color: var(--ok);">üõ°Ô∏è Zero-Harm Commitment</h3>
      <p>
        <strong>Intended Use:</strong> Educational resource for consumer protection. 
        Not legal advice. Not a substitute for professional consultation.
      </p>
      <p>
        <strong>Anti-Weaponization:</strong> This tool is designed to empower consumers, 
        not to harm repair professionals. Honest mechanics deserve respect and fair compensation. 
        Use this checklist to find ethical shops, not to antagonize workers.
      </p>
      <p>
        <strong>Recording Laws:</strong> Check local laws regarding audio/video recording consent. 
        Some jurisdictions require two-party consent. Respect privacy and legal boundaries.
      </p>
      <p>
        <strong>Safety First:</strong> Never endanger yourself or others. If you feel unsafe, 
        leave immediately. Your wellbeing is more important than any repair.
      </p>
      <p class="small muted">
        Data privacy: All information stays on your device. No analytics transmitted without explicit consent. 
        Optional email analytics only if you configure SMTP settings (not included by default).
      </p>
    </section>

    <!-- ============================================
         SECTION: ATTRIBUTIONS & LICENSES
         PURPOSE: Credit sources, respect licenses
         USAGE: Legal compliance, community respect
         EXPECTED: Human-readable license summary
         ============================================ -->
    <section class="card" role="contentinfo" aria-label="Attributions and Licenses">
      <h3 style="margin-top: 0;">üìú Attributions & Licenses</h3>
      
      <h4>Core Patterns Adapted From:</h4>
      <ul style="line-height: 1.8;">
        <li>
          <strong>IndexedDB Best Practices:</strong> 
          <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener">
            MDN Web Docs
          </a> (CC-BY-SA 2.5)
        </li>
        <li>
          <strong>Canvas Starfield Animation:</strong> 
          Inspired by community CodePen examples (MIT License where specified)
        </li>
        <li>
          <strong>Habitica API Integration:</strong> 
          <a href="https://habitica.com/apidoc/" target="_blank" rel="noopener">
            Habitica API Documentation
          </a> (GPL-3.0)
        </li>
        <li>
          <strong>Strategy Bank Concept:</strong> 
          Original design inspired by mycorrhizal networks in ecology, 
          adapted for knowledge management
        </li>
      </ul>

      <h4 style="margin-top: 16px;">License:</h4>
      <p>
        This work is released under 
        <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">
          CC BY-SA 4.0
        </a>. 
        You are free to share and adapt with attribution. 
        Modifications must be shared under the same license.
      </p>

      <p class="small muted" style="margin-top: 12px;">
        <strong>No Warranty:</strong> Provided "as-is" without warranty. 
        Use at your own risk. Verify all advice with qualified professionals.
      </p>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="grid2" style="gap: 32px;">
      <div>
        <h4>üåê Planetary Restoration Archive</h4>
        <p class="small">
          Offline-first architecture. Zero external dependencies. 
          All data stored locally in IndexedDB. Privacy-respecting by design.
        </p>
        <p class="small">
          Presentation Schema: 
          <a href="https://planetaryrestorationarchive.com/ref/crypto/sol/custom/gpt/rare/peace/engineer/hybrid" target="_blank" rel="noopener">
            PRA Hybrid Reference
          </a>
        </p>
      </div>
      
      <div>
        <h4>ü§ù Community</h4>
        <p class="small">
          Help improve this tool: report issues, suggest features, contribute translations. 
          Together we build tools for collective flourishing.
        </p>
        <p class="small">
          ¬© 2025 Steward-Architects for Planetary Restoration. 
          All humans are stewards of Earth's systems.
        </p>
      </div>
    </div>

    <p class="small muted" style="margin-top: 24px; text-align: center; border-top: 1px dashed var(--card-border); padding-top: 24px;">
      Made with intention for a world where trust is the default. 
      May your repairs be honest and your journeys safe. üöó‚ú®
    </p>
  </footer>

  <!-- Statistics Modal -->
  <div id="statsModal" class="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close" id="closeStats" aria-label="Close statistics">&times;</button>
      <h2 id="modal-title">üìä Detailed Statistics</h2>
      
      <div class="stats-grid" style="margin: 20px 0;">
        <div class="stat-card">
          <div class="stat-label">Session Duration</div>
          <div class="stat-number" id="modalSessionTime">0m</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Actions Taken</div>
          <div class="stat-number" id="modalActions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Strategies by Stage</div>
          <div class="small">
            Seed: <span id="modalSeed">0</span><br>
            Mycelium: <span id="modalMycelium">0</span><br>
            Fruiting: <span id="modalFruiting">0</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Impact</div>
          <div class="stat-number" id="modalAvgImpact">0.0</div>
        </div>
      </div>

      <h3>üìà Activity Timeline</h3>
      <div id="activityLog" class="list" style="max-height: 300px;">
        <p class="small muted">No activity recorded yet.</p>
      </div>

      <div class="cta-row" style="margin-top: 20px;">
        <button class="btn" id="btnClearStats">Clear Statistics</button>
        <button class="btn ok" id="closeStatsBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- ============================================
       SECTION: DATA MODEL
       PURPOSE: Define checklist steps as JavaScript constants
       USAGE: Source of truth for checklist items
       EXPECTED: Immutable reference data
       ============================================ -->
  <script>
    // Checklist data model - 19 proven anti-corruption steps
    const CHECKLIST_STEPS = [
      {
        id: "s01",
        t: "Know your vehicle inside out",
        d: "Record make, model, year, mileage, VIN. Keep digital AND paper copies. Include service history. This baseline prevents 'phantom problems'."
      },
      {
        id: "s02",
        t: "List symptoms, not diagnoses",
        d: "Describe what you observe: noises (when/where/pitch), smells (burning/sweet/rotten), visual issues (leaks/smoke), warning lights, handling changes. Let mechanics diagnose."
      },
      {
        id: "s03",
        t: "Research baseline prices",
        d: "Check 3+ sources for typical labor rates ($80-150/hr varies by region) and OEM part costs. Use RepairPal, AAA, or manufacturer sites. Know fair range before estimate."
      },
      {
        id: "s04",
        t: "Bring a documentation witness",
        d: "Second person OR detailed timestamped log. Witnesses prevent 'he-said/she-said'. If solo, use phone voice memo to narrate drop-off details."
      },
      {
        id: "s05",
        t: "Comprehensive photographic documentation",
        d: "Photo checklist: odometer, exterior 360¬∞, tire tread depth, fluid levels, existing damage, dashboard lights. Enable EXIF timestamps. Cloud backup immediately."
      },
      {
        id: "s06",
        t: "Demand itemized written estimates",
        d: "Must include: diagnostic fee (fixed $), part names with part numbers, labor hours (not just total), shop supplies (<5% is normal), taxes, fees. No estimate = walk away."
      },
      {
        id: "s07",
        t: "Request all old parts back",
        d: "Say: 'I want my old parts.' Honest shops comply instantly. Scammers hesitate. Core charges refunded when you return old part. Keep parts for independent inspection."
      },
      {
        id: "s08",
        t: "Verify shop credentials thoroughly",
        d: "Check: state license (current, not suspended), liability insurance certificate, ASE certifications, BBB rating, Google reviews (read negatives). Photo their license plate."
      },
      {
        id: "s09",
        t: "Discreetly mark critical parts",
        d: "Use UV marker, nail polish, or paint pen on: battery terminals, filters, belts, fluid caps. Washable but unique to you. Prevents 'we replaced it' lies."
      },
      {
        id: "s10",
        t: "Assess work environment quality",
        d: "Red flags: disorganized bays, dirty tools, no safety equipment, unprofessional behavior. Green flags: clean workspace, proper lighting, organized tool storage, safety culture."
      },
      {
        id: "s11",
        t: "Written authorization for ANY changes",
        d: "Say: 'Call me before ANY additional work.' Get photo/video of issue, technical explanation why needed, updated written estimate. Never verbal approvals for $100+ changes."
      },
      {
        id: "s12",
        t: "Maintain detailed time logs",
        d: "Note: drop-off time, promised completion, actual completion, pickup time. If '8 hours labor' but finished in 3 hours, you've caught flat-rate abuse."
      },
      {
        id: "s13",
        t: "Never sign blank or incomplete documents",
        d: "Final invoice must show: all parts with prices, actual labor hours worked, all charges itemized. Sign only complete, accurate invoices. Take photo before signing."
      },
      {
        id: "s14",
        t: "Verify parts brand and origin",
        d: "OEM (manufacturer original) is safest. Quality aftermarket (ACDelco, Bosch, Denso) acceptable. Avoid no-name brands. Check part numbers match estimate. Photo packaging."
      },
      {
        id: "s15",
        t: "Immediate comprehensive test drive",
        d: "Within 24 hours: highway speeds, parking lot maneuvers, braking test (safe area), listen for noises, test all functions. Original symptoms gone? New issues? Document everything."
      },
      {
        id: "s16",
        t: "Verify mileage hasn't spiked",
        d: "Test drives add 5-15 miles normally. 50+ miles suspicious. Joyriding or unauthorized use. Photo odometer at pickup, compare to drop-off photo."
      },
      {
        id: "s17",
        t: "Forensically inspect returned parts",
        d: "Compare part wear to claimed necessity. 'Worn brake pads' should show <3mm. 'Blown head gasket' should show coolant contamination. Take macro photos. Get second opinion if suspicious."
      },
      {
        id: "s18",
        t: "Archive complete paper trail",
        d: "Keep forever: all estimates (initial + revised), final invoice, warranty paperwork, photos, correspondence. Scan to cloud. Needed for warranty claims and disputes."
      },
      {
        id: "s19",
        t: "Publish detailed, factual review",
        d: "Rate: honesty, communication clarity, turnaround time, price accuracy. Include specifics but stay factual. Help others. Honest shops deserve recognition; dishonest ones need exposure."
      }
    ];
  </script>

  <!-- ============================================
       SECTION: MAIN APPLICATION LOGIC
       PURPOSE: Core functionality - all features orchestrated here
       USAGE: Self-executing async function
       EXPECTED: IndexedDB init, UI hydration, event binding
       COMPONENTS:
       - Starfield animation (visual engagement)
       - IndexedDB wrapper (persistent storage)
       - Checklist management (progress tracking)
       - Habitica integration (task export)
       - WebLLM bridge (optional AI)
       - Strategy bank (knowledge management)
       - Import/export (data portability)
       - Theme system (visual customization)
       - Analytics (privacy-respecting stats)
       ============================================ -->
  <script>
  (async function() {
    'use strict';

    /* ==========================================
       SUBSECTION: Starfield Animation Engine
       PURPOSE: Parallax background with shooting stars
       EXPECTED: 60fps smooth animation, mouse-reactive
       ========================================== */
    const cvs = document.getElementById('starfield');
    const ctx = cvs.getContext('2d', { alpha: true });
    let W = 0, H = 0, stars = [], tails = [], last = 0, focusX = 0.5, focusY = 0.4;
    const DPR = Math.max(1, Math.min(2, devicePixelRatio || 1));

    function resize() {
      W = cvs.width = Math.floor(window.innerWidth * DPR);
      H = cvs.height = Math.floor(window.innerHeight * DPR);
    }

    window.addEventListener('resize', resize, { passive: true });
    resize();

    function r(n) { return Math.random() * n; }

    function initStars(n = 900) {
      stars.length = 0;
      // Adaptive star count based on screen size
      n = Math.min(1500, Math.floor((window.innerWidth * window.innerHeight) / 1200));
      
      for (let i = 0; i < n; i++) {
        const z = Math.random();
        stars.push({
          x: r(W),
          y: r(H),
          r: (0.6 + Math.random() * 1.8) * (0.5 + 1.5 * z),
          b: 0.7 + 0.3 * Math.random(),
          tw: Math.random() * Math.PI * 2,
          z
        });
      }

      tails.length = 0;
      for (let i = 0; i < 14; i++) {
        tails.push({
          x: r(W),
          y: r(H),
          vx: (-0.5 + Math.random()) * 0.08 * DPR,
          vy: (-0.5 + Math.random()) * 0.08 * DPR,
          life: 2200 + Math.random() * 3800
        });
      }
    }

    initStars();

    window.addEventListener('mousemove', e => {
      focusX = e.clientX / window.innerWidth;
      focusY = e.clientY / window.innerHeight;
    }, { passive: true });

    function draw(now) {
      if (!last) last = now;
      const dt = now - last;
      last = now;
      ctx.clearRect(0, 0, W, H);

      const px = (focusX - 0.5) * 2, py = (focusY - 0.5) * 2;

      // Draw stars with parallax
      for (const s of stars) {
        const tw = 0.75 + 0.25 * Math.sin(s.tw += 0.002 + s.z * 0.004);
        const rr = s.r * tw;
        const x = s.x + px * 40 * s.z;
        const y = s.y + py * 40 * s.z;
        
        const hue = 200 + s.z * 80 + Math.sin(s.tw * 3) * 10;
        const sat = 60 + s.z * 20;
        const light = 70 + s.z * 25 * s.b;
        
        const grd = ctx.createRadialGradient(x, y, 0, x, y, rr * 2);
        grd.addColorStop(0, `hsla(${hue},${sat}%,${light}%,0.95)`);
        grd.addColorStop(0.4, `hsla(${hue},${sat}%,${light - 10}%,0.65)`);
        grd.addColorStop(1, `hsla(${hue},${sat}%,${light - 30}%,0)`);
        
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(x, y, rr * 2, 0, Math.PI * 2);
        ctx.fill();
      }

      // Draw shooting stars
      for (const t of tails) {
        t.x += t.vx * dt;
        t.y += t.vy * dt;
        t.life -= dt;
        
        if (t.life <= 0 || t.x < -50 || t.y < -50 || t.x > W + 50 || t.y > H + 50) {
          t.x = r(W);
          t.y = r(H);
          t.vx = (-0.5 + Math.random()) * 0.08 * DPR;
          t.vy = (-0.5 + Math.random()) * 0.08 * DPR;
          t.life = 2200 + Math.random() * 3800;
        }
        
        const len = 60;
        const grad = ctx.createLinearGradient(t.x, t.y, t.x - t.vx * len, t.y - t.vy * len);
        grad.addColorStop(0, 'rgba(255,255,255,0.6)');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        
        ctx.strokeStyle = grad;
        ctx.lineWidth = 1.5 * DPR;
        ctx.beginPath();
        ctx.moveTo(t.x, t.y);
        ctx.lineTo(t.x - t.vx * len, t.y - t.vy * len);
        ctx.stroke();
      }

      requestAnimationFrame(draw);
    }

    requestAnimationFrame(draw);

    /* ==========================================
       SUBSECTION: IndexedDB Abstraction Layer
       PURPOSE: Simple promise-based storage API
       EXPECTED: Reliable persistence, error handling
       ========================================== */
    const DB = {
      name: 'auto-repair-nexus',
      ver: 3,
      stores: {
        progress: 'progress',
        creds: 'habiticaCreds',
        strategies: 'strategies',
        plans: 'plans',
        analytics: 'analytics'
      }
    };

    let db;

    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB.name, DB.ver);
        
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          
          // Create object stores if they don't exist
          for (const storeName of Object.values(DB.stores)) {
            if (!db.objectStoreNames.contains(storeName)) {
              db.createObjectStore(storeName, { keyPath: 'id' });
            }
          }
        };
        
        req.onsuccess = () => {
          db = req.result;
          resolve(db);
        };
        
        req.onerror = () => reject(req.error);
      });
    }

    async function idbGet(store, id) {
      await idbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(store, 'readonly');
        const s = tx.objectStore(store);
        const r = s.get(id);
        r.onsuccess = () => res(r.result?.value ?? r.result);
        r.onerror = () => rej(r.error);
      });
    }

    async function idbSet(store, payload) {
      await idbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(store, 'readwrite');
        const s = tx.objectStore(store);
        s.put(payload);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    }

    async function idbDel(store, id) {
      await idbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(store, 'readwrite');
        tx.objectStore(store).delete(id);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    }

    async function idbAll(store) {
      await idbOpen();
      return new Promise((res, rej) => {
        const tx = db.transaction(store, 'readonly');
        const s = tx.objectStore(store);
        const out = [];
        const r = s.openCursor();
        r.onsuccess = () => {
          const c = r.result;
          if (c) {
            out.push(c.value);
            c.continue();
          } else {
            res(out);
          }
        };
        r.onerror = () => rej(r.error);
      });
    }

    /* ==========================================
       SUBSECTION: Analytics & Activity Tracking
       PURPOSE: Privacy-respecting usage analytics
       EXPECTED: Local storage only, opt-in for email
       ========================================== */
    const Analytics = {
      sessionStart: Date.now(),
      actions: 0,
      
      async log(action, details = {}) {
        this.actions++;
        const entry = {
          timestamp: Date.now(),
          action,
          details
        };
        
        // Store in IndexedDB
        const log = await idbGet(DB.stores.analytics, 'activityLog') || { id: 'activityLog', entries: [] };
        log.entries.push(entry);
        
        // Keep last 100 entries
        if (log.entries.length > 100) {
          log.entries = log.entries.slice(-100);
        }
        
        await idbSet(DB.stores.analytics, log);
      },
      
      async getStats() {
        const log = await idbGet(DB.stores.analytics, 'activityLog') || { entries: [] };
        const duration = Math.floor((Date.now() - this.sessionStart) / 60000); // minutes
        
        return {
          sessionDuration: duration,
          totalActions: this.actions,
          recentActivity: log.entries.slice(-10).reverse()
        };
      },
      
      async clear() {
        await idbDel(DB.stores.analytics, 'activityLog');
        this.actions = 0;
      }
    };

    /* ==========================================
       SUBSECTION: Utility Functions
       PURPOSE: Reusable helpers for common tasks
       EXPECTED: Type-safe, error-handled utilities
       ========================================== */
    const Utils = {
      flash(msg, duration = 2400) {
        const statusMsg = document.getElementById('statusMsg');
        statusMsg.textContent = msg;
        setTimeout(() => {
          if (statusMsg.textContent === msg) statusMsg.textContent = '';
        }, duration);
      },

      downloadBlob(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      },

      escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m]));
      },

      makeId() {
        return 's_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);
      },

      parseTags(str) {
        return (str || '')
          .split(',')
          .map(t => t.trim().toLowerCase())
          .filter(Boolean)
          .slice(0, 10);
      }
    };

    /* ==========================================
       SUBSECTION: Checklist Management
       PURPOSE: Core checklist UI and persistence
       EXPECTED: Real-time sync to IndexedDB
       ========================================== */
    const Checklist = {
      stepsEl: document.getElementById('steps'),
      progressPctEl: document.getElementById('progressPct'),
      progressCountEl: document.getElementById('progressCount'),
      progressTotalEl: document.getElementById('progressTotal'),
      progressBar: document.getElementById('mainProgressBar'),
      headerProgress: document.getElementById('headerProgress'),

      stepRow(step) {
        const el = document.createElement('div');
        el.className = 'step fade-in';
        el.innerHTML = `
          <input 
            type="checkbox" 
            id="${step.id}" 
            aria-describedby="${step.id}-desc"
          />
          <div class="label">
            <label for="${step.id}">
              <strong>${Utils.escapeHtml(step.t)}</strong>
            </label>
            <div class="small" id="${step.id}-desc">${Utils.escapeHtml(step.d)}</div>
          </div>
        `;
        return el;
      },

      async hydrate() {
        this.stepsEl.innerHTML = '';
        CHECKLIST_STEPS.forEach(s => this.stepsEl.appendChild(this.stepRow(s)));
        this.progressTotalEl.textContent = CHECKLIST_STEPS.length;
        
        const saved = await idbGet(DB.stores.progress, 'checklist') || {};
        
        for (const s of CHECKLIST_STEPS) {
          const cb = document.getElementById(s.id);
          cb.checked = !!saved[s.id];
          cb.addEventListener('change', () => this.onToggle());
        }
        
        this.updateProgress();
      },

      getState() {
        const state = {};
        for (const s of CHECKLIST_STEPS) {
          state[s.id] = !!document.getElementById(s.id).checked;
        }
        return state;
      },

      async onToggle() {
        await idbSet(DB.stores.progress, {
          id: 'checklist',
          value: this.getState()
        });
        this.updateProgress();
        await Analytics.log('checklist_toggle');
      },

      updateProgress() {
        const st = this.getState();
        const done = Object.values(st).filter(Boolean).length;
        const total = CHECKLIST_STEPS.length;
        const pct = Math.round(100 * done / total);
        
        this.progressCountEl.textContent = done;
        this.progressTotalEl.textContent = total;
        this.progressPctEl.textContent = pct + '%';
        this.headerProgress.textContent = pct + '%';
        this.progressBar.style.width = pct + '%';
        this.progressBar.setAttribute('aria-valuenow', pct);
        
        // Update dashboard stats
        document.getElementById('statProgress').textContent = pct + '%';
        document.getElementById('statChecked').textContent = done;
        document.getElementById('statTotal').textContent = total;
      },

      async exportText() {
        const st = this.getState();
        const lines = [
          "Corruption-Proof Auto Repair Checklist",
          "=" .repeat(50),
          "",
          "Generated: " + new Date().toLocaleString(),
          ""
        ];
        
        CHECKLIST_STEPS.forEach((s, i) => {
          lines.push(`[${st[s.id] ? '‚úì' : ' '}] ${i + 1}. ${s.t}`);
          lines.push(`    ${s.d}`);
          lines.push("");
        });
        
        Utils.downloadBlob(lines.join('\n'), 'auto-repair-checklist.txt', 'text/plain');
        Utils.flash('‚úì Exported as text');
        await Analytics.log('export_text');
      },

      async exportPDF() {
        // Trigger browser print dialog (user can save as PDF)
        window.print();
        Utils.flash('Use browser "Save as PDF" option');
        await Analytics.log('export_pdf');
      },

      async reset() {
        if (!confirm('Reset all checklist progress? This cannot be undone.')) return;
        
        await idbDel(DB.stores.progress, 'checklist');
        await this.hydrate();
        Utils.flash('Checklist reset');
        await Analytics.log('checklist_reset');
      }
    };

    /* ==========================================
       SUBSECTION: Habitica Integration
       PURPOSE: Push checklist to Habitica as task
       EXPECTED: Secure API call, error handling
       ========================================== */
    const Habitica = {
      form: document.getElementById('habiticaForm'),
      userInput: document.getElementById('habiticaUser'),
      tokenInput: document.getElementById('habiticaToken'),
      saveMsg: document.getElementById('habiticaSaveMsg'),

      async init() {
        this.form.addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.saveCredentials();
        });

        // Load saved credentials
        const creds = await idbGet(DB.stores.creds, 'habitica');
        if (creds) {
          this.userInput.value = creds.user || '';
          this.tokenInput.value = creds.token || '';
        }
      },

      async saveCredentials() {
        await idbSet(DB.stores.creds, {
          id: 'habitica',
          user: this.userInput.value.trim(),
          token: this.tokenInput.value.trim()
        });
        
        this.saveMsg.textContent = '‚úì Saved locally';
        setTimeout(() => this.saveMsg.textContent = '', 2200);
        await Analytics.log('habitica_credentials_saved');
      },

      async exportTask() {
        const creds = await idbGet(DB.stores.creds, 'habitica');
        
        if (!creds?.user || !creds?.token) {
          alert('Please enter and save your Habitica credentials first.');
          return;
        }

        const st = Checklist.getState();
        const checklist = CHECKLIST_STEPS.map((s, i) => ({
          text: `${i + 1}. ${s.t}`,
          completed: !!st[s.id]
        }));

        const body = {
          text: "Corruption-Proof Auto Repair Checklist",
          type: "todo",
          notes: "Generated offline from Strategy Nexus. Edit and check items as you proceed.",
          checklist
        };

        try {
          const res = await fetch('https://habitica.com/api/v3/tasks/user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-user': creds.user,
              'x-api-key': creds.token
            },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            throw new Error(await res.text());
          }

          Utils.flash('‚úì Pushed to Habitica');
          await Analytics.log('habitica_export_success');
        } catch (e) {
          console.error(e);
          alert('Habitica export failed. Check credentials and network connection.');
          await Analytics.log('habitica_export_error', { error: e.message });
        }
      }
    };

    /* ==========================================
       SUBSECTION: WebLLM Integration
       PURPOSE: Optional on-device AI assistance
       EXPECTED: Works if window.webllm available
       ========================================== */
    const WebLLM = {
      btnLLM: document.getElementById('btnLLM'),
      prompt: document.getElementById('llmPrompt'),
      output: document.getElementById('llmOut'),
      status: document.getElementById('llmStatus'),

      init() {
        this.btnLLM.addEventListener('click', () => this.ask());
      },

      hasWebLLM() {
        return typeof window !== 'undefined' && 
               (window.webllm || window.WebLLM || window.web_llm);
      },

      async ask() {
        const q = this.prompt.value.trim();
        
        if (!q) {
          this.output.textContent = 'Please enter a question first.';
          return;
        }

        if (!this.hasWebLLM()) {
          this.output.textContent = "WebLLM not detected. This requires a local WebLLM build.";
          this.status.textContent = "Tip: Serve this page with a WebLLM-enabled server.";
          return;
        }

        try {
          this.status.textContent = "Thinking on-device...";
          let answer = null;

          if (window.webllm?.chat) {
            const a = await window.webllm.chat([{ role: "user", content: q }], { max_tokens: 256 });
            answer = typeof a === 'string' ? a : (a?.content || JSON.stringify(a));
          } else if (window.WebLLM?.createEngine) {
            const engine = await window.WebLLM.createEngine({ model: "qwen2.5:0.5b-in-browser" });
            const r = await engine.chat.completions.create({
              messages: [{ role: "user", content: q }],
              temperature: 0.2,
              max_tokens: 256
            });
            answer = r?.choices?.[0]?.message?.content || "[no content]";
          } else {
            answer = "WebLLM present but unknown API.";
          }

          this.output.textContent = String(answer).trim();
          this.status.textContent = "";
          await Analytics.log('webllm_query_success');
        } catch (e) {
          console.error(e);
          this.output.textContent = "WebLLM error. Check console.";
          this.status.textContent = "";
          await Analytics.log('webllm_query_error', { error: e.message });
        }
      }
    };

    /* ==========================================
       SUBSECTION: Strategy Bank Management
       PURPOSE: Mycelial knowledge base with plans
       EXPECTED: Full CRUD, filtering, export/import
       ========================================== */
    const StrategyBank = {
      // Form elements
      title: document.getElementById('stTitle'),
      stage: document.getElementById('stStage'),
      impact: document.getElementById('stImpact'),
      tags: document.getElementById('stTags'),
      desc: document.getElementById('stDesc'),
      msg: document.getElementById('stMsg'),
      
      // Filter elements
      fltText: document.getElementById('fltText'),
      fltTag: document.getElementById('fltTag'),
      fltStage: document.getElementById('fltStage'),
      
      // List elements
      strategyList: document.getElementById('strategyList'),
      masterList: document.getElementById('masterList'),
      grandList: document.getElementById('grandList'),
      
      // State
      editId: null,
      
      init() {
        // Button listeners
        document.getElementById('btnAddStrategy').addEventListener('click', () => this.upsert());
        document.getElementById('btnClearStrategy').addEventListener('click', () => this.clearForm());
        document.getElementById('btnApplyFilter').addEventListener('click', () => this.loadFiltered());
        document.getElementById('btnResetFilter').addEventListener('click', () => this.resetFilter());
        document.getElementById('btnExportStrategies').addEventListener('click', () => this.exportStrategies());
        document.getElementById('btnExportMaster').addEventListener('click', () => this.exportPlan('master'));
        document.getElementById('btnExportGrand').addEventListener('click', () => this.exportPlan('grandmaster'));
        document.getElementById('btnClearMaster').addEventListener('click', () => this.clearPlan('master'));
        document.getElementById('btnClearGrand').addEventListener('click', () => this.clearPlan('grandmaster'));
        document.getElementById('btnExportAll').addEventListener('click', () => this.exportAll());
        document.getElementById('btnWipeAll').addEventListener('click', () => this.wipeAll());
        
        // List click handlers
        this.strategyList.addEventListener('click', (e) => this.handleStrategyClick(e));
        this.masterList.addEventListener('click', (e) => this.handlePlanClick(e, 'master'));
        this.grandList.addEventListener('click', (e) => this.handlePlanClick(e, 'grandmaster'));
        
        // Drag-drop import
        this.initDragDrop();
      },

      async loadFiltered() {
        const all = await idbAll(DB.stores.strategies);
        const t = (this.fltText.value || '').toLowerCase();
        const tag = (this.fltTag.value || '').toLowerCase();
        const stg = this.fltStage.value || '';
        
        const filtered = all.filter(s => {
          if (t && !(s.title.toLowerCase().includes(t) || (s.desc || '').toLowerCase().includes(t))) return false;
          if (tag && !(s.tags || []).includes(tag)) return false;
          if (stg && s.stage !== stg) return false;
          return true;
        }).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        
        this.strategyList.innerHTML = filtered.map(s => this.strategyHTML(s)).join('') || 
          '<p class="small muted">No strategies match your filters. Try different criteria.</p>';
        
        // Update header stat
        document.getElementById('headerStrategies').textContent = all.length;
        document.getElementById('statStrategies').textContent = all.length;
      },

      strategyHTML(s) {
        const when = new Date(s.updatedAt || s.createdAt).toLocaleString();
        const stageEmoji = { seed: 'üå±', mycelium: 'üçÑ', fruiting: 'üéØ' };
        
        return `
          <div class="strategy fade-in" data-id="${s.id}">
            <div class="kbar">
              <span class="pill">${stageEmoji[s.stage]} ${Utils.escapeHtml(s.stage)}</span>
              <span class="pill">‚ö° Impact: ${Number(s.impact) || 1}/5</span>
              <span class="pill small">üïê ${Utils.escapeHtml(when)}</span>
            </div>
            <h4>${Utils.escapeHtml(s.title)}</h4>
            <div class="muted" style="margin: 6px 0;">
              ${(s.tags || []).map(t => `<span class="tag">${Utils.escapeHtml(t)}</span>`).join(' ')}
            </div>
            <p class="small" style="white-space: pre-wrap;">${Utils.escapeHtml(s.desc || '')}</p>
            <div class="cta-row">
              <button class="btn ok" data-act="add-master">‚ûï Master</button>
              <button class="btn acc" data-act="add-grand">‚ûï Grandmaster</button>
              <button class="btn" data-act="edit">‚úèÔ∏è Edit</button>
              <button class="btn bad" data-act="delete">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      },

      async handleStrategyClick(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const wrap = e.target.closest('.strategy');
        const id = wrap?.dataset?.id;
        if (!id) return;
        
        const act = btn.dataset.act;
        const rec = await idbGet(DB.stores.strategies, id);
        if (!rec) return;

        switch (act) {
          case 'add-master':
            await this.planAdd('master', rec.id);
            await this.renderPlans();
            Utils.flash('Added to Master Plan');
            await Analytics.log('strategy_add_to_master', { id });
            break;
            
          case 'add-grand':
            await this.planAdd('grandmaster', rec.id);
            await this.renderPlans();
            Utils.flash('Added to Grandmaster Plan');
            await Analytics.log('strategy_add_to_grand', { id });
            break;
            
          case 'edit':
            this.editId = rec.id;
            this.title.value = rec.title;
            this.desc.value = rec.desc || '';
            this.stage.value = rec.stage;
            this.impact.value = rec.impact || 3;
            this.tags.value = (rec.tags || []).join(', ');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            await Analytics.log('strategy_edit_start', { id });
            break;
            
          case 'delete':
            if (!confirm('Delete this strategy? This cannot be undone.')) return;
            await idbDel(DB.stores.strategies, id);
            await this.removeFromAllPlans(id);
            await this.loadFiltered();
            await this.renderPlans();
            Utils.flash('Strategy deleted');
            await Analytics.log('strategy_delete', { id });
            break;
        }
      },

      async upsert() {
        const titleVal = this.title.value.trim();
        
        if (!titleVal) {
          this.msg.textContent = '‚ö†Ô∏è Title required';
          setTimeout(() => this.msg.textContent = '', 2000);
          return;
        }

        const now = Date.now();
        const rec = {
          id: this.editId || Utils.makeId(),
          title: titleVal,
          desc: this.desc.value.trim(),
          stage: ['seed', 'mycelium', 'fruiting'].includes(this.stage.value) ? this.stage.value : 'seed',
          impact: Math.max(1, Math.min(5, Number(this.impact.value) || 1)),
          tags: Utils.parseTags(this.tags.value),
          lineage: { origin: 'local', parents: this.editId ? [this.editId] : [] },
          createdAt: this.editId ? (await idbGet(DB.stores.strategies, this.editId))?.createdAt || now : now,
          updatedAt: now
        };

        await idbSet(DB.stores.strategies, rec);
        
        this.editId = null;
        this.clearForm();
        this.msg.textContent = '‚úì Saved';
        setTimeout(() => this.msg.textContent = '', 1600);
        
        await this.loadFiltered();
        await Analytics.log('strategy_save', { id: rec.id });
      },

      clearForm() {
        this.editId = null;
        this.title.value = '';
        this.desc.value = '';
        this.stage.value = 'seed';
        this.impact.value = '3';
        this.tags.value = '';
      },

      resetFilter() {
        this.fltText.value = '';
        this.fltTag.value = '';
        this.fltStage.value = '';
        this.loadFiltered();
      },

      async exportStrategies() {
        const all = await idbAll(DB.stores.strategies);
        Utils.downloadBlob(
          JSON.stringify({ type: 'strategies', version: 1, items: all }, null, 2),
          'strategies.json',
          'application/json'
        );
        Utils.flash('‚úì Strategies exported');
        await Analytics.log('export_strategies');
      },

      // Plan management
      async planGet(id) {
        const p = await idbGet(DB.stores.plans, id);
        if (p) return p;
        
        const init = {
          id,
          name: id === 'master' ? 'Master Plan' : 'Grandmaster Plan',
          version: 1,
          items: [],
          updatedAt: Date.now()
        };
        
        await idbSet(DB.stores.plans, init);
        return init;
      },

      async planSet(p) {
        p.updatedAt = Date.now();
        await idbSet(DB.stores.plans, p);
      },

      async planAdd(id, sid) {
        const p = await this.planGet(id);
        
        if (!p.items.some(x => x.sid === sid)) {
          p.items.push({ sid, ref: true, addedAt: Date.now() });
          await this.planSet(p);
        }
      },

      async planRemove(id, sid) {
        const p = await this.planGet(id);
        p.items = p.items.filter(x => x.sid !== sid);
        await this.planSet(p);
      },

      async removeFromAllPlans(sid) {
        const m = await this.planGet('master');
        const g = await this.planGet('grandmaster');
        
        m.items = m.items.filter(x => x.sid !== sid);
        g.items = g.items.filter(x => x.sid !== sid);
        
        await this.planSet(m);
        await this.planSet(g);
      },

      planItemHTML(s, planId) {
        const stageEmoji = { seed: 'üå±', mycelium: 'üçÑ', fruiting: 'üéØ' };
        
        return `
          <div class="strategy fade-in" data-id="${s.id}" data-plan="${planId}">
            <div class="kbar">
              <span class="pill">${stageEmoji[s.stage]} ${Utils.escapeHtml(s.stage)}</span>
              <span class="pill">‚ö° ${Number(s.impact) || 1}/5</span>
            </div>
            <h4>${Utils.escapeHtml(s.title)}</h4>
            <div class="muted">
              ${(s.tags || []).map(t => `<span class="tag">${Utils.escapeHtml(t)}</span>`).join(' ')}
            </div>
            <p class="small" style="white-space: pre-wrap;">${Utils.escapeHtml(s.desc || '')}</p>
            <div class="cta-row">
              <button class="btn bad" data-act="remove">‚ùå Remove</button>
              <button class="btn" data-act="clone">üîÄ Clone</button>
            </div>
          </div>
        `;
      },

      async renderPlans() {
        const [m, g, all] = await Promise.all([
          this.planGet('master'),
          this.planGet('grandmaster'),
          idbAll(DB.stores.strategies)
        ]);
        
        const byId = new Map(all.map(x => [x.id, x]));
        
        this.masterList.innerHTML = m.items
          .map(it => byId.get(it.sid))
          .filter(Boolean)
          .map(s => this.planItemHTML(s, 'master'))
          .join('') || '<p class="small muted">Empty. Add strategies to Master Plan.</p>';
        
        this.grandList.innerHTML = g.items
          .map(it => byId.get(it.sid))
          .filter(Boolean)
          .map(s => this.planItemHTML(s, 'grandmaster'))
          .join('') || '<p class="small muted">Empty. Add strategies to Grandmaster Plan.</p>';
        
        // Update stats
        document.getElementById('statMaster').textContent = m.items.length;
        document.getElementById('statGrand').textContent = g.items.length;
      },

      async handlePlanClick(e, planId) {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const wrap = e.target.closest('.strategy');
        const id = wrap?.dataset?.id;
        if (!id) return;
        
        const act = btn.dataset.act;

        switch (act) {
          case 'remove':
            await this.planRemove(planId, id);
            await this.renderPlans();
            Utils.flash('Removed from plan');
            await Analytics.log('plan_remove_item', { planId, strategyId: id });
            break;
            
          case 'clone':
            const src = await idbGet(DB.stores.strategies, id);
            if (!src) return;
            
            const clone = {
              ...src,
              id: Utils.makeId(),
              title: src.title + ' (clone)',
              createdAt: Date.now(),
              updatedAt: Date.now(),
              lineage: { origin: 'local', parents: [src.id].concat(src.lineage?.parents || []) }
            };
            
            await idbSet(DB.stores.strategies, clone);
            await this.loadFiltered();
            Utils.flash('Strategy cloned');
            await Analytics.log('strategy_clone', { originalId: id, cloneId: clone.id });
            break;
        }
      },

      async exportPlan(id) {
        const p = await this.planGet(id);
        Utils.downloadBlob(
          JSON.stringify({ type: 'plan', id: p.id, name: p.name, version: p.version, items: p.items }, null, 2),
          `${id}-plan.json`,
          'application/json'
        );
        Utils.flash(`‚úì ${id} plan exported`);
        await Analytics.log('export_plan', { planId: id });
      },

      async clearPlan(id) {
        if (!confirm(`Clear all items from ${id} plan? This cannot be undone.`)) return;
        
        const p = await this.planGet(id);
        p.items = [];
        await this.planSet(p);
        await this.renderPlans();
        Utils.flash(`${id} plan cleared`);
        await Analytics.log('plan_clear', { planId: id });
      },

      async exportAll() {
        const dump = {
          type: 'full-backup',
          version: 1,
          timestamp: Date.now(),
          strategies: await idbAll(DB.stores.strategies),
          plans: await idbAll(DB.stores.plans)
        };
        
        Utils.downloadBlob(
          JSON.stringify(dump, null, 2),
          'strategy-nexus-backup.json',
          'application/json'
        );
        Utils.flash('‚úì Full backup exported');
        await Analytics.log('export_full_backup');
      },

      async wipeAll() {
        if (!confirm('‚ö†Ô∏è WIPE ALL STRATEGIES AND PLANS? This action is PERMANENT and cannot be undone!')) return;
        if (!confirm('Are you absolutely sure? This will delete everything.')) return;
        
        // Wipe strategies
        const strategies = await idbAll(DB.stores.strategies);
        for (const s of strategies) {
          await idbDel(DB.stores.strategies, s.id);
        }
        
        // Wipe plans
        const plans = await idbAll(DB.stores.plans);
        for (const p of plans) {
          await idbDel(DB.stores.plans, p.id);
        }
        
        await this.renderPlans();
        await this.loadFiltered();
        
        Utils.flash('All data wiped', 3000);
        await Analytics.log('wipe_all_data');
      },

      // Drag-drop import
      initDragDrop() {
        window.addEventListener('dragover', e => e.preventDefault(), false);
        
        window.addEventListener('drop', async e => {
          e.preventDefault();
          
          const file = e.dataTransfer?.files?.[0];
          if (!file) return;
          
          try {
            const text = await file.text();
            const obj = JSON.parse(text);
            let added = 0, merged = 0;

            if (obj.type === 'strategies' && Array.isArray(obj.items)) {
              for (const s of obj.items) {
                if (!s?.id || !s?.title) continue;
                const exists = await idbGet(DB.stores.strategies, s.id);
                if (exists) {
                  merged++;
                } else {
                  added++;
                }
                await idbSet(DB.stores.strategies, s);
              }
              await this.loadFiltered();
            } else if (obj.type === 'plan' && Array.isArray(obj.items) && obj.id) {
              const p = await this.planGet(obj.id === 'master' ? 'master' : obj.id === 'grandmaster' ? 'grandmaster' : obj.id);
              const set = new Set(p.items.map(i => i.sid));
              
              for (const it of obj.items) {
                if (!set.has(it.sid)) {
                  p.items.push({ sid: it.sid, ref: true, addedAt: Date.now() });
                  added++;
                } else {
                  merged++;
                }
              }
              
              await this.planSet(p);
              await this.renderPlans();
            } else if (obj.type === 'full-backup') {
              if (Array.isArray(obj.strategies)) {
                for (const s of obj.strategies) {
                  if (!s?.id) continue;
                  const ex = await idbGet(DB.stores.strategies, s.id);
                  if (ex) merged++; else added++;
                  await idbSet(DB.stores.strategies, s);
                }
              }
              
              if (Array.isArray(obj.plans)) {
                for (const p of obj.plans) {
                  if (!p?.id) continue;
                  await idbSet(DB.stores.plans, p);
                }
              }
              
              await this.loadFiltered();
              await this.renderPlans();
            } else {
              throw new Error('Unknown JSON format');
            }

            document.getElementById('importMsg').textContent = `‚úì Imported: ${added} added, ${merged} merged`;
            setTimeout(() => document.getElementById('importMsg').textContent = '', 4000);
            await Analytics.log('import_data', { added, merged, type: obj.type });
          } catch (err) {
            console.error(err);
            document.getElementById('importMsg').textContent = '‚ö†Ô∏è Import failed: ' + (err.message || err);
            setTimeout(() => document.getElementById('importMsg').textContent = '', 4000);
            await Analytics.log('import_error', { error: err.message });
          }
        }, false);
      }
    };

    /* ==========================================
       SUBSECTION: Theme System
       PURPOSE: Multi-theme visual customization
       EXPECTED: Instant theme switching
       ========================================== */
    const ThemeSystem = {
      selector: document.getElementById('themeSelector'),
      
      init() {
        // Load saved theme
        const saved = localStorage.getItem('theme') || 'space';
        this.selector.value = saved;
        this.apply(saved);
        
        this.selector.addEventListener('change', (e) => {
          const theme = e.target.value;
          this.apply(theme);
          localStorage.setItem('theme', theme);
          Analytics.log('theme_change', { theme });
        });
      },
      
      apply(theme) {
        document.body.setAttribute('data-theme', theme);
      }
    };

    /* ==========================================
       SUBSECTION: Statistics Modal
       PURPOSE: Detailed analytics dashboard
       EXPECTED: Real-time stats, activity log
       ========================================== */
    const StatsModal = {
      modal: document.getElementById('statsModal'),
      btnOpen: document.getElementById('btnStats'),
      btnClose: document.getElementById('closeStats'),
      btnCloseAlt: document.getElementById('closeStatsBtn'),
      btnClearStats: document.getElementById('btnClearStats'),
      
      init() {
        this.btnOpen.addEventListener('click', () => this.open());
        this.btnClose.addEventListener('click', () => this.close());
        this.btnCloseAlt.addEventListener('click', () => this.close());
        this.btnClearStats.addEventListener('click', () => this.clearStats());
        
        // Close on backdrop click
        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) this.close();
        });
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.modal.classList.contains('active')) {
            this.close();
          }
        });
      },
      
      async open() {
        const stats = await Analytics.getStats();
        const strategies = await idbAll(DB.stores.strategies);
        
        // Count by stage
        const stages = { seed: 0, mycelium: 0, fruiting: 0 };
        let totalImpact = 0;
        
        for (const s of strategies) {
          stages[s.stage] = (stages[s.stage] || 0) + 1;
          totalImpact += (s.impact || 0);
        }
        
        const avgImpact = strategies.length > 0 ? (totalImpact / strategies.length).toFixed(1) : 0;
        
        // Update modal content
        document.getElementById('modalSessionTime').textContent = stats.sessionDuration + 'm';
        document.getElementById('modalActions').textContent = stats.totalActions;
        document.getElementById('modalSeed').textContent = stages.seed;
        document.getElementById('modalMycelium').textContent = stages.mycelium;
        document.getElementById('modalFruiting').textContent = stages.fruiting;
        document.getElementById('modalAvgImpact').textContent = avgImpact;
        
        // Activity log
        const activityLog = document.getElementById('activityLog');
        if (stats.recentActivity.length > 0) {
          activityLog.innerHTML = stats.recentActivity.map(entry => {
            const time = new Date(entry.timestamp).toLocaleTimeString();
            return `
              <div class="small" style="padding: 8px; border-bottom: 1px dashed var(--card-border);">
                <strong>${time}</strong> - ${entry.action}
              </div>
            `;
          }).join('');
        } else {
          activityLog.innerHTML = '<p class="small muted">No activity recorded yet.</p>';
        }
        
        this.modal.classList.add('active');
        await Analytics.log('stats_modal_open');
      },
      
      close() {
        this.modal.classList.remove('active');
      },
      
      async clearStats() {
        if (!confirm('Clear all statistics? This cannot be undone.')) return;
        
        await Analytics.clear();
        document.getElementById('activityLog').innerHTML = '<p class="small muted">Statistics cleared.</p>';
        document.getElementById('modalActions').textContent = '0';
        Utils.flash('Statistics cleared');
      }
    };

    /* ==========================================
       SUBSECTION: Global Event Handlers
       PURPOSE: Top-level button click handlers
       EXPECTED: Wire up all major actions
       ========================================== */
    document.getElementById('btnExportText').addEventListener('click', () => Checklist.exportText());
    document.getElementById('btnExportPDF').addEventListener('click', () => Checklist.exportPDF());
    document.getElementById('btnPrint').addEventListener('click', () => Checklist.exportPDF());
    document.getElementById('btnReset').addEventListener('click', () => Checklist.reset());
    document.getElementById('btnExportHabitica').addEventListener('click', () => Habitica.exportTask());

    /* ==========================================
       SUBSECTION: Application Bootstrap
       PURPOSE: Initialize all systems on load
       EXPECTED: Smooth startup, error resilience
       ========================================== */
    async function boot() {
      try {
        // Initialize all subsystems
        await Checklist.hydrate();
        await Habitica.init();
        WebLLM.init();
        await StrategyBank.init();
        await StrategyBank.loadFiltered();
        await StrategyBank.renderPlans();
        ThemeSystem.init();
        StatsModal.init();
        
        // Log session start
        await Analytics.log('session_start');
        
        console.log('%cüîß Auto Repair Strategy Nexus Initialized', 'color: #66e3ff; font-size: 16px; font-weight: bold;');
        console.log('%cOffline-first ‚Ä¢ Privacy-respecting ‚Ä¢ Zero-harm', 'color: #77ff9f; font-size: 12px;');
      } catch (error) {
        console.error('Boot error:', error);
        alert('Initialization error. Check console for details.');
      }
    }

    // Start the application
    await boot();

  })();
  </script>

  <!-- ============================================
       SECTION: ANTI-INVERSION & SAFETY NOTICE
       PURPOSE: Explicit ethical commitment
       USAGE: Always visible in source
       EXPECTED: Legal clarity, harm prevention
       ============================================
       
       ZERO-HARM DECLARATION:
       
       This tool is designed exclusively for consumer protection and education.
       It is NOT intended for:
       - Harassing honest mechanics
       - Facilitating frivolous disputes
       - Circumventing legitimate repair costs
       - Any form of bad-faith use
       
       INTENDED USE:
       - Empower consumers with knowledge
       - Identify ethical repair shops
       - Document legitimate concerns
       - Build trust in automotive services
       
       LEGAL COMPLIANCE:
       - Recording laws vary by jurisdiction
       - Check local consent requirements
       - Respect privacy boundaries
       - Use ethically and responsibly
       
       LIABILITY WAIVER:
       - Provided "as-is" without warranty
       - Not legal or professional advice
       - User assumes all risk
       - Verify with qualified professionals
       
       ATTRIBUTION:
       - CC BY-SA 4.0 License
       - Must credit original source
       - Share modifications openly
       - Respect community norms
       
       ============================================ -->
</body>
</html>
